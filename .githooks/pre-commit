#!/bin/bash

# Firefighter Game Pre-Commit Hook
# Validates code quality and completeness before commits

set -e

echo "üîç Running pre-commit validation..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for critical game files
echo "üìã Checking for critical game files..."
REQUIRED_FILES=(
    "js/GameLevel.js"
    "js/InteractionHandler.js"
    "js/LayeredRenderer.js"
    "js/SoundManager.js"
    "js/VoiceGuide.js"
    "js/main.js"
    "index.html"
)

MISSING_FILES=()
for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        MISSING_FILES+=("$file")
    fi
done

if [ ${#MISSING_FILES[@]} -ne 0 ]; then
    echo -e "${RED}‚ùå Missing critical files:${NC}"
    printf '%s\n' "${MISSING_FILES[@]}"
    echo -e "${YELLOW}üí° Make sure all core game files are committed${NC}"
    exit 1
fi

# JavaScript syntax validation
echo "üîß Validating JavaScript syntax..."
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$' || true)
if [ -n "$JS_FILES" ]; then
    for file in $JS_FILES; do
        if [ -f "$file" ]; then
            node -c "$file" || {
                echo -e "${RED}‚ùå Syntax error in $file${NC}"
                exit 1
            }
        fi
    done
fi

# Check for large files being committed
echo "üìä Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(wc -c < "{}") -gt 1048576 ]; then echo "{}"; fi' || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES"
    echo -e "${YELLOW}üí° Consider using Git LFS for large assets${NC}"
fi

# Check for console.log statements (except in testing files)
echo "üßπ Checking for console.log statements..."
CONSOLE_LOGS=$(git diff --cached --name-only | grep '\.js$' | grep -v 'testing\.js' | xargs grep -l "console\.log" 2>/dev/null || true)
if [ -n "$CONSOLE_LOGS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  console.log statements found in:${NC}"
    echo "$CONSOLE_LOGS"
    echo -e "${YELLOW}üí° Consider removing console.log statements before production${NC}"
fi

# Check commit message format (if not amending)
if [ -n "$1" ] && [ "$1" != "amend" ]; then
    COMMIT_MSG_FILE="$1"
    if [ -f "$COMMIT_MSG_FILE" ]; then
        COMMIT_MSG=$(head -n1 "$COMMIT_MSG_FILE")
        if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+'; then
            echo -e "${RED}‚ùå Invalid commit message format${NC}"
            echo -e "${YELLOW}Expected: type(scope): description${NC}"
            echo -e "${YELLOW}Examples: feat: add new level, fix(ui): button alignment${NC}"
            exit 1
        fi
    fi
fi

echo -e "${GREEN}‚úÖ Pre-commit validation passed!${NC}"